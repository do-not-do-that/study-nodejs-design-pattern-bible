# Node.js는 어떻게 작동하는가

단일 스레드 아키텍처와 논 블로킹 I/O 같은 주요 개념을 살펴보고,

이것이 어떻게 Node.js 플랫폼의 전체 기반을 만들게 되었는지 봅시다.
<br/><br/><br/>

## I/O는 느리다

I/O는 컴퓨터의 기본적인 동작들 중에서 가장 느립니다.

RAM의 전송률은 GB/s 단위로 일관되게 유지되지만, 디스크나 네트워크의 전송률은 MB/s에서 GB/s까지 다양합니다.
<br/><br/><br/>

## 블로킹 I/O

전통적인 블로킹 I/O 프로그래밍에서는 I/O를 요청하는 함수의 호출은 작업이 완료될 때까지 스레드의 실행을 차단합니다.

아래 의사코드는 소켓을 가지고 작업이 수행되는 일반적인 블로킹 스레드를 보여줍니다.

```
// data가 사용가능해질 때까지 스레드 블로킹
data = socket.read();
// data 사용가능
print(data);
```

블로킹 I/O를 사용하여 구현된 웹 서버가 같은 스레드 내에서 여러 연결을 처리하지 못하는 것은 자명한 일입니다.

문제를 해결하기 위한 전통적인 접근 방법은 각각의 동시 연결을 처리하기 위해서 개별의 스레드 또는 프로세스를 사용하는 것입니다.

다만, 이는 I/O작업의 결과를 위하여 스레드가 꽤 많이 블로킹되어 비용이 비쌉니다.
<br/><br/><br/>

## 논 블로킹 I/O

대부분의 최신 운영체제는 리소스에 접근하기 위해 블로킹 I/O 외에도 논 블로킹 I/O라고 불리는 다른 메커니즘을 지원합니다.

이 운영모드에서 시스템 호출은 데이터가 읽혀지거나 쓰여지기를 기다리지 않고, 항상 **즉시 반환** 됩니다.

이러한 종류의 논 블로킹 I/O를 다루는 가장 기본적인 패턴은

실제 데이터가 반환될 때까지 루프 내에서 리소스를 적극적으로 폴링하는 것입니다.

이는 여전히 효율적이지 않고, 사용할 수 없는 리소스를 가지려 소중한 CPU를 사용합니다.😭
<br/><br/><br/>

## 이벤트 디멀티플렉싱

대부분의 운영체제는 논 블로킹 리소스를 효율적인 방법으로 처리하기 위한 기본적인 메커니즘을 제공합니다.

이 메커니즘을 **동기 이벤트 디멀티플렉서** 또는 **이벤트 통지 인터페이스** 라고합니다.
책을 읽어보았으나, 용어는 그닥 중요하지않다고 느꼈습니다.

결국 핵심은, **이벤트 디멀티플렉싱** 이 Node.js가 한번에 많은 작업을 처리할 수 있게 하는 비법이라는 것입니다!

이벤트 디멀티플렉싱은 여러 개의 비동기 작업을 동시에 기다리면서, 그 작업들이 언제 완료되는지 체크하는 역할을 합니다.

이벤트 루프는 이 디멀티플렉서로부터 정보를 받아 처리할 작업을 하나씩 순차적으로 처리하게 됩니다.

<br/><br/><br/>

## 리액터 패턴

리액터 패턴은 이벤트가 발생할 때마다 그에 맞는 콜백함수를 호출해 처리를 분배하는 패턴입니다.

핵심은, 하나의 진입 지점에서 모든 I/O 이벤트를 처리하고, 이벤트가 발생할 때 콜백을 통해 처리를 넘겨주는 방식이라는 것입니다.

리액터 패턴을 사용하는 애플리케이션에서는 아래와 같은 일이 발생합니다.

1. 애플리케이션은 **이벤트 디멀티플렉서** 에 요청을 전달하여 새로운 I/O작업을 생성합니다.

또한, 애플리케이션은 작업이 완료되었을 때 호출될 핸들러를 명시합니다.

**이벤트 디멀티플렉서** 에 새로운 요청을 전달하는 것은 논 블로킹 호출이고, 제어권은 애플리케이션으로 즉시 반환됩니다.

2. I/O 작업들이 완료되면 이벤트 디멀티플렉서는 대응하는 이벤트 작업들을 **이벤트 큐**에 넣습니다.

3. 이 시점에서 **이벤트 루프** 가 **이벤트 큐** 의 항목들을 순환합니다.

4. 각 이벤트와 관련된 핸들러가 호출됩니다.

5. 애플리케이션 코드의 일부인 핸들러의 실행이 완료되면 제어권을 **이벤트 루프**에 되돌려줍니다.

6. **이벤트 큐** 의 모든 항목이 처리되고 나면 이벤트 루프는 이벤트 디멀티플렉서에서 블로킹됩니다.

<br/>
비동기적 동작이 비교적 명확해졌습니다.
애플리케이션은 특정 시점에 리소스로 접근하고 싶다는 요청과 동시에 작업이 완료되었을 때 호출된 핸들러를 제공합니다.
<br/><br/><br/>

## Libuv, Node.js의 I/O 엔진

각 운영체제는 이벤트 디멀티플렉서를 위한 자체 인터페이스를 가지고 있습니다.

게다가 각 I/O 작업은 동일한 운영체제 내에서도 리소스 유형에 따라 다르게 동작할 수 있습니다.

이러한 상황으로 인해 이벤트 디멀티플렉서를 위하여 보다 더 높은 레벨의 추상화가 필요했습니다.

그래서 등장한 것이 **libuv** 입니다.

**libuv** 는 Node.js를 주요 운영체제에서 호환되게 하고, 다른 리소스 유형의 논 블로킹 동작을 표준화하기 위해 제작되었습니다.
<br/><br/><br/>

## Node.js를 위한 구성

Node.js 를 위한 구성은 아래와 같습니다.

- libuv
- libuv와 다른 저수준 기능들을 랩핑하고 표출시키기 위한 바인딩 세트
- v8엔진
- 고수준 Node.js API를 구현하고 있는 코어 JavaScript 라이브러리
